<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" >
<style>
body { font-family: verdana; margin: 20px; background-color: #f4f4f4; }
.container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border: 1px solid #ccc; }
.btn { padding: 8px 12px; background-color: #003366; color: white; border: none; cursor: pointer; font-family: verdana; font-size: small; margin-right: 5px; }
.btn:hover { background-color: #005599; }
.btn-danger { background-color: #800000; }
.btn-danger:hover { background-color: #a00000; }
.btn-success { background-color: #006600; }
.docket-row { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
.docket-row:last-child { border-bottom: none; }
#editor-toolbar { background: #eee; padding: 5px; border: 1px solid #ccc; border-bottom: none; }
#docket-editor { min-height: 300px; border: 1px solid #ccc; padding: 10px; background: white; overflow-y: auto; }
input[type="text"], input[type="email"], input[type="password"], input[type="date"] { padding: 8px; border: 1px solid #ccc; }
</style>
<title>Beth Din Management</title>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Beth Din Docket Management</h2>
        <a href="beth-din.html" style="font-size: small;">&laquo; Back to Public Search</a>
    </div>

    <!-- Auth Section -->
    <div id="auth-container">
        <div id="login-form">
            <h3>Staff Login</h3>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn">Login</button>
            </form>
            <p id="login-error" style="color: red;"></p>
        </div>
        
        <div id="logged-in-menu" style="display: none; background: #eef; padding: 10px; margin-bottom: 20px;">
            Logged in as: <strong id="user-display"></strong>
            <div style="float: right;">
                <button onclick="handleLogout()" class="btn btn-danger">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Content (Hidden until logged in) -->
    <div id="management-content" style="display: none;">
        
        <!-- List View -->
        <div id="list-view">
            <div style="margin-bottom: 15px;">
                <button onclick="showCreateMode()" class="btn btn-success">+ Create New Docket</button>
                <input type="text" id="admin-search" placeholder="Filter dockets..." onkeyup="renderAdminList()" style="margin-left: 10px; width: 250px;">
            </div>
            <div id="admin-dockets-list" style="border-top: 2px solid #003366;">
                <p>Loading...</p>
            </div>
        </div>

        <!-- Editor View -->
        <div id="editor-view" style="display: none;">
            <h3 id="editor-heading">Create/Edit Docket</h3>
            <input type="hidden" id="edit-docket-id">
            <input type="text" id="docket-title-input" placeholder="Docket Title / Case Number" style="width: 100%; font-size: 18px; margin-bottom: 10px; box-sizing: border-box;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: small; font-weight: bold; display: block; margin-bottom: 3px;">Docket # (Auto):</label>
                    <input type="text" id="docket-number" readonly style="width: 100%; background: #eee; color: #555; box-sizing: border-box;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: small; font-weight: bold; display: block; margin-bottom: 3px;">Filing Date:</label>
                    <input type="date" id="filing-date" style="width: 100%; box-sizing: border-box;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: small; font-weight: bold; display: block; margin-bottom: 3px;">Filing Location:</label>
                    <input type="text" id="filing-location" placeholder="e.g. Boston, MA" style="width: 100%; box-sizing: border-box;">
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: small; font-weight: bold; display: block; margin-bottom: 3px;">Visibility:</label>
                    <select id="docket-visibility" style="width: 100%; padding: 8px; border: 1px solid #ccc;" onchange="togglePinInput()">
                        <option value="public">Public</option>
                        <option value="pin">PIN Protected</option>
                        <option value="hidden">Hidden</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <div id="pin-wrapper" style="visibility: hidden;">
                        <label style="font-size: small; font-weight: bold; display: block; margin-bottom: 3px;">Access PIN (4-8 digits):</label>
                        <input type="text" id="docket-pin" placeholder="Required for PIN Protected" maxlength="8" style="width: 100%; box-sizing: border-box;">
                    </div>
                </div>
                <div style="flex: 1;"></div>
            </div>

            <div style="margin-bottom: 10px; background: #f9f9f9; padding: 10px; border: 1px solid #ddd;">
                <label style="font-size: small; font-weight: bold; margin-right: 10px;">Use Template:</label>
                <select id="template-select" onchange="applyTemplate()" style="padding: 5px; width: 200px;">
                    <option value="">-- Select Template --</option>
                    <optgroup label="Premade" id="premade-templates-group">
                        <!-- JS populated -->
                    </optgroup>
                    <optgroup label="My Templates" id="custom-templates-group">
                        <!-- JS populated -->
                    </optgroup>
                </select>
                <button onclick="deleteSelectedTemplate()" id="btn-delete-template" class="btn btn-danger" style="display:none; padding: 4px 8px; font-size: 10px; margin-left: 10px;">Delete Template</button>
            </div>

            <div id="editor-toolbar">
                <button type="button" onclick="document.execCommand('bold',false,null)"><b>B</b></button>
                <button type="button" onclick="document.execCommand('italic',false,null)"><i>I</i></button>
                <button type="button" onclick="document.execCommand('underline',false,null)"><u>U</u></button>
                <button type="button" onclick="document.execCommand('insertOrderedList',false,null)">OL</button>
                <button type="button" onclick="document.execCommand('insertUnorderedList',false,null)">UL</button>
            </div>
            <div id="docket-editor" contenteditable="true"></div>
            
            <div style="margin-top: 15px;">
                <button onclick="saveDocket()" class="btn btn-success">Save Docket</button>
                <button onclick="saveAsTemplate()" class="btn" style="background-color: #666;">Save as Template</button>
                <button onclick="cancelEdit()" class="btn">Cancel</button>
            </div>
        </div>

    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDa-q7h7VTuHxffftGK44NhKKfLt0w8qjM",
        authDomain: "rccr-main.firebaseapp.com",
        projectId: "rccr-main",
        storageBucket: "rccr-main.firebasestorage.app",
        messagingSenderId: "221328154434",
        appId: "1:221328154434:web:a6000a45f5d4ba964532db",
        measurementId: "G-97BBMTGDR0"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let allDockets = [];
    let customTemplates = [];

    const premadeTemplates = {
        "premade_summons": {
            name: "Summons",
            content: "<h3>Summons to Beth Din</h3><p><strong>To:</strong> [Party Name]</p><p>You are hereby summoned to appear before the Rabbinical Council of the Charles River Beth Din regarding the matter of: <strong>[Case Subject]</strong>.</p><p><strong>Date:</strong> [Date]<br><strong>Time:</strong> [Time]<br><strong>Location:</strong> [Location]</p><p>Please contact the Beth Din to confirm your attendance.</p>"
        },
        "premade_psak": {
            name: "Psak Din (Judgment)",
            content: "<h3>Psak Din</h3><p><strong>Case Reference:</strong> [Case Number]</p><p>The undersigned Dayanim, having heard the claims and evidence presented by both parties, hereby issue the following ruling:</p><ol><li>[Ruling Point 1]</li><li>[Ruling Point 2]</li></ol><p><strong>So Ordered.</strong></p><p>Signed:<br>____________________<br>____________________<br>____________________</p>"
        }
    };

    // Auth Logic
    auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('logged-in-menu').style.display = 'block';
            document.getElementById('management-content').style.display = 'block';
            document.getElementById('user-display').textContent = user.email;
            loadDockets();
            loadTemplates();
        } else {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('logged-in-menu').style.display = 'none';
            document.getElementById('management-content').style.display = 'none';
        }
    });

    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        auth.signInWithEmailAndPassword(email, pass).catch(err => {
            document.getElementById('login-error').textContent = err.message;
        });
    }

    function handleLogout() {
        auth.signOut();
    }

    // Data Logic
    function loadDockets() {
        db.collection('dockets').orderBy('timestamp', 'desc').get().then(qs => {
            allDockets = [];
            qs.forEach(doc => {
                allDockets.push({ id: doc.id, ...doc.data() });
            });
            renderAdminList();
        });
    }

    function loadTemplates() {
        db.collection('docketTemplates').orderBy('name').get().then(qs => {
            customTemplates = [];
            qs.forEach(doc => {
                customTemplates.push({ id: doc.id, ...doc.data() });
            });
            renderTemplateOptions();
        }).catch(err => {
            console.error("Error loading templates:", err);
        });
    }

    function renderAdminList() {
        const container = document.getElementById('admin-dockets-list');
        const term = document.getElementById('admin-search').value.toLowerCase();
        
        const filtered = allDockets.filter(d => 
            (d.title && d.title.toLowerCase().includes(term))
        );

        if (filtered.length === 0) {
            container.innerHTML = '<p>No dockets found.</p>';
            return;
        }

        container.innerHTML = '';
        filtered.forEach(d => {
            const div = document.createElement('div');
            div.className = 'docket-row';
            const dateStr = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
            div.innerHTML = `
                <div>
                    <strong>${d.title.replace(/</g, '&lt;')}</strong><br>
                    <span style="font-size: small; color: #666;">${dateStr}</span>
                </div>
                <div>
                    <button onclick="editDocket('${d.id}')" class="btn">Edit</button>
                    <button onclick="deleteDocket('${d.id}')" class="btn btn-danger">Delete</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // Editor Logic
    function showCreateMode() {
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('editor-view').style.display = 'block';
        document.getElementById('editor-heading').textContent = 'Create New Docket';
        document.getElementById('edit-docket-id').value = '';
        document.getElementById('docket-title-input').value = '';
        document.getElementById('docket-number').value = 'Will be generated on save';
        document.getElementById('filing-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('filing-location').value = '';
        document.getElementById('docket-visibility').value = 'public';
        document.getElementById('docket-pin').value = '';
        togglePinInput();
        document.getElementById('docket-editor').innerHTML = '';
        document.getElementById('template-select').value = '';
        document.getElementById('btn-delete-template').style.display = 'none';
    }

    function editDocket(id) {
        const docket = allDockets.find(d => d.id === id);
        if (!docket) return;

        document.getElementById('list-view').style.display = 'none';
        document.getElementById('editor-view').style.display = 'block';
        document.getElementById('editor-heading').textContent = 'Edit Docket';
        document.getElementById('edit-docket-id').value = id;
        document.getElementById('docket-title-input').value = docket.title;
        document.getElementById('docket-number').value = docket.docketNumber || 'N/A';
        document.getElementById('filing-date').value = docket.filingDate || '';
        document.getElementById('filing-location').value = docket.filingLocation || '';
        document.getElementById('docket-visibility').value = docket.visibility || 'public';
        document.getElementById('docket-pin').value = docket.pin || '';
        togglePinInput();
        document.getElementById('docket-editor').innerHTML = docket.content;
        document.getElementById('template-select').value = '';
        document.getElementById('btn-delete-template').style.display = 'none';
    }

    function cancelEdit() {
        document.getElementById('editor-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'block';
    }

    function saveDocket() {
        const id = document.getElementById('edit-docket-id').value;
        const title = document.getElementById('docket-title-input').value.trim();
        const content = document.getElementById('docket-editor').innerHTML;
        let docketNumber = document.getElementById('docket-number').value;
        const filingDate = document.getElementById('filing-date').value;
        const filingLocation = document.getElementById('filing-location').value;
        const visibility = document.getElementById('docket-visibility').value;
        const pin = document.getElementById('docket-pin').value.trim();

        if (visibility === 'pin') {
            if (!/^\d{4,8}$/.test(pin)) {
                return alert('For PIN Protected dockets, please enter a 4-8 digit PIN.');
            }
        }

        if (!title) return alert('Title is required');

        if (docketNumber === 'Will be generated on save' || !docketNumber) {
            docketNumber = 'DN-' + Date.now();
        }

        const data = {
            title: title,
            docketNumber: docketNumber,
            filingDate: filingDate,
            filingLocation: filingLocation,
            content: content,
            visibility: visibility,
            pin: (visibility === 'pin') ? pin : null,
            searchable: (title + " " + content).toLowerCase(),
            author: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Update timestamp on edit? Or keep original? Usually update.
        };

        let promise;
        if (id) {
            // Update
            promise = db.collection('dockets').doc(id).update(data);
        } else {
            // Create
            promise = db.collection('dockets').add(data);
        }

        promise.then(() => {
            alert('Saved successfully');
            cancelEdit();
            loadDockets();
        }).catch(err => alert('Error: ' + err.message));
    }

    function deleteDocket(id) {
        if (!confirm('Are you sure you want to delete this docket? This cannot be undone.')) return;
        
        db.collection('dockets').doc(id).delete().then(() => {
            // Remove from local array to update UI instantly or reload
            allDockets = allDockets.filter(d => d.id !== id);
            renderAdminList();
        }).catch(err => alert('Error deleting: ' + err.message));
    }

    function stripHtml(html) {
        let tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
    }

    function togglePinInput() {
        const vis = document.getElementById('docket-visibility').value;
        const wrapper = document.getElementById('pin-wrapper');
        wrapper.style.visibility = (vis === 'pin') ? 'visible' : 'hidden';
    }

    // Template Logic
    function renderTemplateOptions() {
        const premadeGroup = document.getElementById('premade-templates-group');
        const customGroup = document.getElementById('custom-templates-group');
        
        premadeGroup.innerHTML = '';
        customGroup.innerHTML = '';

        for (const [key, val] of Object.entries(premadeTemplates)) {
            const opt = document.createElement('option');
            opt.value = key;
            opt.textContent = val.name;
            premadeGroup.appendChild(opt);
        }

        customTemplates.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = t.name;
            customGroup.appendChild(opt);
        });
    }

    function applyTemplate() {
        const select = document.getElementById('template-select');
        const val = select.value;
        const btnDelete = document.getElementById('btn-delete-template');
        
        if (!val) {
            btnDelete.style.display = 'none';
            return;
        }

        // Check if custom template to show delete button
        const isCustom = customTemplates.find(t => t.id === val);
        btnDelete.style.display = isCustom ? 'inline-block' : 'none';

        if (document.getElementById('docket-editor').innerHTML.trim().length > 10) {
            if (!confirm("This will overwrite the current content. Continue?")) {
                select.value = "";
                return;
            }
        }

        let content = "";
        if (premadeTemplates[val]) {
            content = premadeTemplates[val].content;
        } else if (isCustom) {
            content = isCustom.content;
        }

        document.getElementById('docket-editor').innerHTML = content;
    }

    function saveAsTemplate() {
        const content = document.getElementById('docket-editor').innerHTML;
        if (!content) return alert("Editor is empty.");
        
        const name = prompt("Enter a name for this template:");
        if (!name) return;

        db.collection('docketTemplates').add({
            name: name,
            content: content,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("Template saved!");
            loadTemplates();
        }).catch(err => alert("Error saving template: " + err.message));
    }

    function deleteSelectedTemplate() {
        const select = document.getElementById('template-select');
        const id = select.value;
        if (!id) return;
        
        if (!confirm("Delete this template?")) return;

        db.collection('docketTemplates').doc(id).delete().then(() => {
            alert("Template deleted.");
            select.value = "";
            loadTemplates();
            document.getElementById('btn-delete-template').style.display = 'none';
        }).catch(err => alert("Error deleting: " + err.message));
    }
</script>
</body>
</html>